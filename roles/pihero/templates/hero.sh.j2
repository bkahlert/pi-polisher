#!/bin/bash

declare hero
printf -v hero '\033[33m─=≡\033[91mΣ\033[90m\033[101m((\033[30m\033[43m[ \033[31m蓬\033[30m•\033[91mｏ\033[30m•]\033[0m\033[93m⊐\033[0m'

# TODO move share code to separate script

newest_dhcp_lease() {
  iface="${1:-.*}"
  journalctl --boot --unit dnsmasq.service --grep 'DHCPACK\('"$iface"'\)' --output cat --reverse --lines 1
}

dns_set() {
  dns_servers=('8.8.8.8' '8.8.4.4')
  printf "Configuring dnsmasq to use DNS servers \033[3m%s\033[23m...\n" "${dns_servers[*]}" >&2
  printf 'server=%s\n' "${dns_servers[@]}" >/etc/dnsmasq.d/hero-dns.conf
  systemctl restart dnsmasq.service
}

dns_unset() {
  printf "Removing dnsmasq DNS servers...\n" >&2
  [ -f /etc/dnsmasq.d/hero-dns.conf ] || { printf "No servers set.\n" >&2 && return 0; }
  rm /etc/dnsmasq.d/hero-dns.conf
  systemctl restart dnsmasq.service
}

add_default_route() {
  host_ip="${1?host IP missing}"
  printf "Adding default route via \033[3m%s\033[23m...\n" "$host_ip" >&2
  ip route add default via "$host_ip"
}

delete_default_route() {
  host_ip="${1?host IP missing}"
  printf "Deleting default route via \033[3m%s\033[23m...\n" "$host_ip" >&2
  ip route delete default via "$host_ip"
}

main() {
  printf "%s \033[33m%s\033[0m\n" "$hero" "Pi Hero" >&2
  local cmd
  if [ $# -eq 0 ]; then
    cmd=diag
  else
    cmd=$1
    shift
  fi

  case "$cmd" in
      diag)
        printf -v line "\033[1m%0.s—\033[0m" $(seq 1 "$(tput cols)")
        printf "\033[1mBluetooth PAN diagnostics\033[0m\n%s\n" "$line" >&2
        /opt/pihero/bt-pan-diag
        exit_code=$?
        printf "\n" >&2
        printf "\033[1mUSB gadget diagnostics\033[0m\n%s\n" "$line" >&2
        /opt/pihero/usb-gadget diag && [ $exit_code -eq 0 ]
        ;;
      *pan)
          if [ "$#" -eq 0 ]; then
            /opt/pihero/bt-pan-diag
          elif [ "${1:-}" = diag ]; then
            /opt/pihero/bt-pan-diag "${@:1}"
          else
            sudo /opt/pihero/bt-pan "$@"
          fi
      ;;
      *gadget)
          if [ "$#" -eq 0 ]; then
            /opt/pihero/usb-gadget diag
          elif [ "${1:-}" = diag ]; then
            /opt/pihero/usb-gadget "$@"
          else
            sudo /opt/pihero/usb-gadget "$@"
          fi
      ;;
      share)
          case "${1:-}" in
          start|stop)
            lease=$(newest_dhcp_lease 2>/dev/null) || {
              printf "\033[33mFailed to find host. No corresponding DHCP lease was found.\033[0m\n" >&2
              exit 1
            }
            IFS=' ' read -ra c <<< "$lease"
            self_name="$(hostnamectl --pretty status)"
            host_ip="${c[1]}" # [1]=IP, [2]=MAC, [3]=hostname
            host_name="${c[3]}"
            if [ "$1" = "start" ]; then
              printf "Preparing \033[3m%s\033[23m to use \033[3m%s\033[23m (\033[3m%s\033[23m) as upstream...\033[0m\n" \
                "$self_name" "$host_name" "$host_ip" >&2
              if add_default_route "$host_ip" && dns_set; then
                printf "Done \033[32m✔︎\033[0m\n" >&2
                printf "\033[1mDon't forget to activate routing on \033[3m%s\033[23m!\033[0m\n" "$host_name" >&2
              else
                printf "\033[31mFailed to prepare \033[3m%s\033[23m to use \033[3m%s\033[23m (\033[3m%s\033[23m) as upstream.\033[0m\n" \
                  "$self_name" "$host_name" "$host_ip" >&2
                exit 1
              fi
            else
              printf "Stopping \033[3m%s\033[23m from using \033[3m%s\033[23m (\033[3m%s\033[23m) as upstream...\033[0m\n" \
                "$self_name" "$host_name" "$host_ip" >&2
              if dns_unset && delete_default_route "$host_ip"; then
                printf "Done \033[32m✔︎\033[0m\n" >&2
                printf "\033[1mDon't forget to deactivate routing on \033[3m%s\033[23m!\033[0m\n" "$host_name" >&2
              else
                printf "\033[31mFailed to stop \033[3m%s\033[23m from using \033[3m%s\033[23m (\033[3m%s\033[23m) as upstream.\033[0m\n" \
                  "$self_name" "$host_name" "$host_ip" >&2
                exit 1
              fi
            fi
            ip route show
            ;;
          *)
            printf "Usage: %s \033[3m%s\033[23m \033[3m%s\033[23m\n" "${0##*/}" share 'start|stop' >&2
            exit 1
            ;;
          esac
      ;;
      *)
        printf "Usage: %s \033[3m%s\033[23m [\033[3m%s\033[23m]\n" "${0##*/}" "diag|pan|gadget|share" "SUBCOMMANDS..." >&2
        exit 1
      ;;
  esac
}

main "$@"
