#!/bin/bash

shopt -s nullglob # expand to nothing if no match

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"

# shellcheck source=./../lib/lib.bash
source "$SCRIPT_DIR/../lib/lib.bash"

# Prints the Pi Hero kaomoji in the given mood.
# Globals:
#   None
# Arguments:
#   test (flag, optional): If specified, print one kaomoji for each mood.
#   mood (string, default: neutral): The mood to use.
# Outputs:
#   1: The kaomoji in the given mood.
# Returns:
#   0: Always
hero() {
    local mood=neutral face

    if [ $# -gt 0 ] && [ "$1" = --test ]; then
        shift
        local rows=()
        for mood in neutral happy sad unknown; do
            m=$(gum style --faint "$mood")
            k=$(CLICOLOR_FORCE=${CLICOLOR_FORCE-1} hero --mood "$mood")
            row=$(gum join --vertical --align center "$k" '' "$m")
            rows+=("$(gum style --padding "1 2" "$row")")
        done
        gum join --vertical "${rows[@]}"
        exit
    fi

    while [ $# -gt 0 ]; do
        case "$1" in
        --mood=*)
            mood="${1#*=}" && shift
            ;;
        --mood)
            shift && mood=${1?mood: parameter value not set} && shift
            ;;
        *)
            break
            ;;
        esac
    done

    case "$mood" in
    neutral)
        face=(' ' '蓬' '•' 'ｏ' '•' '')
        ;;
    0 | happy)
        face=('' '✿' '＾' 'ｖ' '＾' '')
        ;;
    1 | 2 | sad)
        face=(' ' '༶' '◕' '︿' '◕' ' ')
        ;;
    *)
        face=('' '༶' '´⊙' '﹏' '⊙`' '')
        ;;
    esac

    local parts=(
        '{{ Foreground "3" "─" }}'
        '{{ Foreground "3" "=" }}'
        '{{ Foreground "3" "≡" }}'
        '{{ Foreground "9" "Σ" }}'
        '{{ Color "8" "9" "(" }}'
        '{{ Color "8" "9" "(" }}'
        '{{ Color "0" "3" "[" }}'
        '{{ Color "0" "3" "'"${face[0]}"'" }}'
        '{{ Color "1" "3" "'"${face[1]}"'" }}'
        '{{ Color "0" "3" "'"${face[2]}"'" }}'
        '{{ Color "9" "3" "'"${face[3]}"'" }}'
        '{{ Color "0" "3" "'"${face[4]}"'" }}'
        '{{ Color "1" "3" "'"${face[5]}"'" }}'
        '{{ Color "0" "3" "]" }}'
        '{{ Foreground "11" "⊐" }}'
    )
    gum format --type template "$(printf '%s' "${parts[@]}")"
}

customize_cli() {
    if is_tty; then
        export DIE_TEMPLATE && DIE_TEMPLATE=" $(hero --mood sad) "'{{ Foreground "1" "%s" }}'$'\n'
    fi

    export GUM_CHOOSE_CURSOR
    GUM_CHOOSE_CURSOR=" $(CLICOLOR_FORCE=1 hero --mood=neutral) "
    export GUM_CHOOSE_CURSOR_FOREGROUND='11' # 3=yellow + 8=bright
}

# TODO call share with sudo

main() {
    if [ "$1" = --test ]; then
        hero "$@"
        exit $?
    fi

    customize_cli
    local extension_dirs=("$SCRIPT_DIR/..")
    local extensions && mapfile -t extensions < <(list_extensions "${extension_dirs[@]}")

    [ $# -gt 0 ] || exec_completed --name command diag "${extensions[@]}"
    local cmd=$1 && shift

    # run all diagnostics
    if [ "$cmd" = diag ]; then
        printf "\n %s \e[1;33m%s\e[0m\n\n" "$(hero --mood=neutral)" "Pi Hero" >&2
        local result=0 diagnostics=()

        for cmd in "${extensions[@]}"; do
            run_extension_command "$cmd" diag "${extension_dirs[@]}"
            diagnostics+=("$cmd" "$?")
            printf '\n' >&2
        done

        local summary=''
        while ((${#diagnostics[@]} > 0)); do
            local icon
            if [ "${diagnostics[1]}" -eq 0 ]; then
                printf -v icon '\e[32m✔︎\e[0m'
            else
                printf -v icon '\e[31m✘︎\e[0m'
                result=1
            fi
            printf -v summary '%s   \e[1m%s %s\e[0m' "$summary" "${diagnostics[0]}" "$icon"
            diagnostics=("${diagnostics[@]:2}")
        done
        printf ' %s%s\n' "$(hero --mood="$result")" "$summary" >&2
        printf '\n' >&2

        exit "$result"
    fi

    # match extension command
    local extension
    for extension in "${extensions[@]}"; do
        if [ "$cmd" = "$extension" ]; then
            local subcommands && mapfile -t subcommands < <(list_extension_commands "$extension" "${extension_dirs[@]}")
            [ "${#subcommands[@]}" -gt 0 ] || hero_die sad "no commands found for extension $extension"

            [ $# -gt 0 ] || exec_completed --name subcommand "${subcommands[@]}" -- "$cmd"
            local subcmd=$1 && shift

            local subcommand
            for subcommand in "${subcommands[@]}"; do
                if [ "$subcmd" = "$subcommand" ]; then
                    run_extension_command "$cmd" "$subcmd" "${extension_dirs[@]}" -- "$@"
                    exit $?
                fi
            done

            # no subcommand matched
            usage --name subcommand "${subcommands[@]}" -- "$cmd"
            for t in 0 1 2; do
                if [ -t "$t" ]; then
                    echo "t$t: yes"
                else
                    echo "t$t: no"
                fi
            done
            die "subcommand $subcmd not found"
        fi
    done

    # no command matched
    usage --name command diag "${extensions[@]}"
    die "command $cmd not found"
}

main "$@"
