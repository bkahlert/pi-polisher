# PiPolisher [![License](https://img.shields.io/github/license/bkahlert/hello?color=29ABE2&label=License&logo=data%3Aimage%2Fsvg%2Bxml%3Bbase64%2CPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1OTAgNTkwIiAgeG1sbnM6dj0iaHR0cHM6Ly92ZWN0YS5pby9uYW5vIj48cGF0aCBkPSJNMzI4LjcgMzk1LjhjNDAuMy0xNSA2MS40LTQzLjggNjEuNC05My40UzM0OC4zIDIwOSAyOTYgMjA4LjljLTU1LjEtLjEtOTYuOCA0My42LTk2LjEgOTMuNXMyNC40IDgzIDYyLjQgOTQuOUwxOTUgNTYzQzEwNC44IDUzOS43IDEzLjIgNDMzLjMgMTMuMiAzMDIuNCAxMy4yIDE0Ny4zIDEzNy44IDIxLjUgMjk0IDIxLjVzMjgyLjggMTI1LjcgMjgyLjggMjgwLjhjMCAxMzMtOTAuOCAyMzcuOS0xODIuOSAyNjEuMWwtNjUuMi0xNjcuNnoiIGZpbGw9IiNmZmYiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIxOS4yMTIiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz48L3N2Zz4%3D)](https://github.com/bkahlert/hello/blob/master/LICENSE) [![Buy Me A Unicorn](https://img.shields.io/static/v1?label=&message=Buy%20Me%20A%20Unicorn&color=c21f73&logo=data%3Aimage%2Fsvg%2Bxml%3Bbase64%2CPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA3MiA3MiI%2BPHBhdGggZmlsbD0iI0ZGRiIgZD0iTTIzLjc1NCAxMi4zNjJsMS42NjcgNy4xNjctNS4zMzMgNS4zMzMtOC4zMzQgMTQuMzMzIDEgNC42NjcgMi4xNjcgMS4zMzMgNC0uMTY3IDMuNS0zLjMzMyA2LjgzMy0xLjgzM3MxLjMzNCAxLjUgMi4xNjcgMyAzLjY2NyA0LjE2NyAzLjY2NyA0LjE2N2wuNSA2LTEuODMzIDYuMTY2LTIgMi44MzNzMjIgOS41IDMzLjE2Ni03bC0uNS02LTEuODMzLTUtMy4zMzMtNS4xNjYtMS0xLjUtLjE2Ny01LjE2Ny0yLjgzMy01LjMzMy01LTMtMi42NjctNC41LTUuMTY3LTQuMTY3LTYuNS0xLjUtNS42NjYgMS00LjE2Ny0yLjE2Ny0yLjMzNC0uMTY2eiIvPjxwYXRoIGZpbGw9IiNFQTVBNDciIGQ9Ik01MC42NzEgMjMuMTU1bDUuMjA4IDQuMDk1czUuNTY0IDguMjE4LS4zMjUgMTcuODJjLTcuMDUgMTEuNDkyIDAgMCAwIDAtMS42MTkgMy40NzUtMi4zMTUgNi43NDItMS43MzkgOS43MjJsLTUuMzEtNC40MTdWMzQuMjkybDIuMTY2LTExLjEzN3pNMjUuODk4IDE5LjI3MWwtMTUuMTEzLTcuMjUgNS4xNjYgNi4xMTkgNS4yMjQgNS44NTUgNC43MjMtNC43MjQiLz48cGF0aCBmaWxsPSIjOTJEM0Y1IiBkPSJNMjkuNzM3IDEzLjYzMWwxMC43NjcuMTM2czkuMjM4IDQuMDY2IDEwLjUzNiAxMS44MTZsLjY4NyA4Ljk1N2MtMi42MzMgNi41MzktMy4wNTYgMTQuMTI3IDIuMDg5IDIwLjgzNCAwIDAtNy4xNDUgMS4zMjEtOS44OTUtNy4xMUw0Mi4zMzggNDMuNWwuMzI1LTYuMDM0IDEuNDE3LTUuNjQzLS4yODMtNC44OTMtMi4yNzYtNC4zMTItMy41MzItMi44NDEtNS43OTItMi4wOC0yLjQ2LTQuMDY2Ii8%2BPHBhdGggZmlsbD0iIzYxQjJFNCIgZD0iTTU4LjQ1NSAzNi43NXM1LjUyIDYuNDA3IDYuOTk4IDE1LjEyYTguMDIgOC4wMiAwIDAxLS4xMzggMy4yNThjLS40MzEgMS43NTItLjgxNyA0Ljk5OC4xNDYgNy4zODMuNDY5IDEuMTYxLS41NjIgMi4zNjUtMS43ODkgMi4xMTEtMy43MS0uNzY4LTkuMjQzLTMuNjQ3LTEwLjI1Ni04LjA4N2ExLjgyNiAxLjgyNiAwIDAxLS4wNDItLjMyMWwtLjI2Ni01Ljc0NmMtLjAxMy0uMjg2LjA1Mi0uNTcuMTg3LS44MjFsMy42OTItNi44MzZjLjA2Ny0uMTIzLjExNy0uMjU1LjE0OS0uMzkybDEuMzE5LTUuNjY5Ii8%2BPGc%2BPHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDAwIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgc3Ryb2tlLXdpZHRoPSIyIiBkPSJNNTguNDU1IDM3Ljc4M0M2MC4yMjMgNDAuMTQ0IDY1IDQ0LjQ2NSA2NC41IDU0LjAyTTMyLjUgNDEuODg1czguNDc4IDYuNzgzIDAgMTguNzY1TTI0LjgwOSAxOS4xMzRMMTAuMjUgMTEuNzVsMTAuOTI1IDEyLjI0NSIvPjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHN0cm9rZS13aWR0aD0iMiIgZD0iTTM1LjE5NiAzMC44N2MuNTUgOC4zNTUtOS4zMjIgOS43MDMtMTEuOTU0IDEwLjMzNC0uMzMyLjA4LS42MzIuMjUtLjg3My40OTJsLTIuMjIzIDIuMjIzYy0uMzUuMzUtLjgyNC41NDYtMS4zMTguNTQ2aC0zLjUxMmEyLjc5NSAyLjc5NSAwIDAxLTIuNjUxLTEuOTExbC0uNTMxLTEuNTkzYTIuNzk1IDIuNzk1IDAgMDEuMjU1LTIuMzIybDguNzg2LTE0LjY0NCA0LjcyNC00LjcyNC0yLjExNi02LjkwNXM3LjgwMy0uNjk5IDguNDE0IDUuMzNjMCAwIDE2LjkyOCAyLjQ0MiAxMC41NTMgMTkuMzg0IDAgMC0xLjYyNSA1Ljk0OSAyLjM3NSAxMS4xODRNMzAuOTE3IDE0LjAyUzUzLjE2IDEwIDUwLjg3NSAzMy45OCIvPjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHN0cm9rZS13aWR0aD0iMiIgZD0iTTQ5LjkxOSAyMy4xNTVzMTQuNzY2IDYuNTg3IDUuNDU2IDIyLjIyYzAgMC01LjM3NSA2LjU2My42MjUgMTMuNjA0Ii8%2BPGNpcmNsZSBjeD0iMjQuNDE3IiBjeT0iMjguOTMiIHI9IjIiLz48L2c%2BPC9zdmc%2B)](https://www.buymeacoffee.com/bkahlert)

## About

**PiPolisher** is an Ansible-based set of scripts to make your Raspberry Pi
discoverable, accessible, and fun to use.

- mDNS
    - Avahi is installed and configured to advertise the hostname and configured services.
    - Your Raspberry Pi shows up automatically in your network as a 4th-generation AirPort device (configurable).
- Samba shares
    - Home directories are shared, for example `/home/pi`
    - The root directory `/` is shared read-only
- Ethernet over USB
    - Connect your computer to the USB OTG port (the one in the middle), and you can access your Raspberry Pi with no Wi-Fi or Ethernet cable.  
      Ideal for early Raspberry Pi models, like the Raspberry Pi Zero.
    - Your computer is automatically configured with DHCP.
    - The default `10.10.10.10/29` assigns `10.10.10.10` to your Raspberry Pi
      and uses the remaining address `10.10.10.9` and `10.10.10.11-14` to configure connected devices.
    - You can configure any IP address range you like, for example `10.10.20.10/29`,
      to allow for multiple Raspberry Pis to be connected at the same time.
- Mass storage over USB
- Serial port over USB
    - Connect with `screen $(ls /dev/tty.usbmodem* | head -n 1) 115200`, exit with `Ctrl+A` `K`
    - Connect with `cu -s 115200 -l $(ls /dev/tty.usbmodem* | head -n 1)`, exit with `~.`
    - Connect with `minicom -b 115200 -D $(ls /dev/tty.usbmodem* | head -n 1)`, exit with `Meta+Z` `X`

# TODO add screenshots

## Usage

- Flash the latest Raspberry Pi OS Lite image to your SD card.
- Boot your Raspberry Pi and connect it to your network.

| Using Wi-Fi                                                                                                           | Using Ethernet                                                       | Using USB                                                  |
|-----------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------|------------------------------------------------------------|
| Configure your Wi-Fi upfront.<br>The easiest way to do that is using the Raspberry Pi Imager's customization feature. | Connect your Pi with an Ethernet cable to your DHCP enabled network. | Use a USB to Ethernet adapter and connect to your network. |

- Locate your Raspberry Pi
    - Ideally you should be able to ping your device using `ping raspberry.local`, or the hostname you configured.
    - If that doesn't work, you can
        - use [netmon](https://github.com/bkahlert/netmon),
        - check your Router's web interface, or
        - scan your network with `nmap -sn nmap -sn 192.168.0.0/24` *(adapt to your network)*
    - If you can't, you can use `nmap` to scan your network for devices:

- Once you located your Raspberry Pi, either by name or IP, run:
  ```shell
  pip install -r requirements.txt
  ansible-galaxy collection install -r requirements.yml
  ansible-playbook playbook.yml \
    -e "inventory=raspberrypi" \
    -i inventory/hosts.yml
  ```

- Wait for the playbook to finish and your Raspberry Pi to reboot.

- **If you used a USB to Ethernet adapter, you should remove the adapter and connect to your computer directly.** You can do so when the Raspberry Pi is about
  to reboot.
    - If you missed this moment, just unplug the adapter and restart.

**Your Raspberry Pi is now ready to use.  
It should show up properly in your network.  
No matter if you're using Wi-Fi, Ethernet, or USB.**

Log in using `ssh raspberry.local` and you'll be greeted
with a message containing information about the configured features:

```text
Linux gadget 6.1.21-v8+ #1642 SMP PREEMPT aarch64

⸺̲͞ (((ꎤ ✧曲✧)—̠͞o Samba
  - /home/$USER shares: smb://raspberrypi.local/$USER
  - / share: smb://raspberrypi.local/rootfs (read-only)
  - To access the shares, run 'sudo smbpasswd -a $USER' 
    to set the Samba password.

⸺̲͞ (((ꎤ ✧曲✧)—̠͞o USB gadget
  - Functions: mass_storage, serial, ethernet
  - To use the functions, connect to this machine by attaching 
    the USB OTG port to a computer with a USB cable.
    If you run into issues, you can run: sudo usb-gadget-diag

⸺̲͞ (((ꎤ ✧曲✧)—̠͞o USB ethernet
  - Interface: usb0 managed by dnsmasq (/etc/dnsmasq.d/usb0.conf)
  - IP address: 10.10.10.10 / 255.255.255.248
  - DHCP range: 10.10.10.11 - 10.10.10.14

Last login from 10.10.10.12
```

## Debugging

The Ansible playbook placed a diagnosis script on the target machine.
You can run it with:

```shell
sudo usb-network-diag
```

It produces output like the following with additional hints
on how to proceed

```
Checking if /boot/config.txt contains dtoverlay=dwc2... ✔︎
Checking if /boot/cmdline.txt contains modules-load=dwc2... ✔︎
Checking if /boot/cmdline.txt contains no line breaks... ✔︎
Checking if libcomposite module is loaded... ✔︎
Checking if usb-gadget-setup service is active... ✔︎
# ...
Checking if usb0 interface config is not malformed... ✔︎
Checking if usb0 interface config is not malformed... ✔︎
Checking if usb0 interface exists... ✔︎
All checks passed.

Further debugging:
  - check usb-gadget-setup service: systemctl status usb-gadget-setup.service; journalctl -f -u usb-gadget-setup.service
  - run usb-gadget-setup yourself: sudo usb-gadget-setup
  - scan for connected hosts: command -v nmap >/dev/null 2>&1 || sudo apt-get install -yqq nmap; nmap -sn 10.10.10.11-14
  - check networking: systemctl status networking
  - check dnsmasq service: systemctl status dnsmasq.service
  - check dnsmasq config: dnsmasq --test
  - stop dnsmasq service: sudo systemctl stop dnsmasq.service
  - start dnsmasq manually: dnsmasq --no-daemon --log-queries
```

## Contributing

Want to contribute? Awesome! The most basic way to show your support is to star the project, or to raise issues. You
can also support this project by making
a [PayPal donation](https://www.paypal.me/bkahlert) to ensure this journey continues indefinitely!

Thanks again for your support, it is much appreciated! :pray:

## License

MIT. See [LICENSE](LICENSE) for more details.
